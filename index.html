<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÐšÐ°Ð¼ÐµÑ€Ð° (Broadcaster)</title>
  </head>
  <body>
    <video id="localVideo" autoplay playsinline></video>
    <script>
      const startStream = async () => {
        let socket;
        let peerConnection;

        try {
          // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¼ÐµÐ´Ñ–Ð°Ð¿Ð¾Ñ‚Ñ–Ðº
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false,
          });
          const videoElement = document.getElementById("localVideo");
          videoElement.srcObject = stream;
          console.log("âœ… Ð’Ñ–Ð´ÐµÐ¾ Ð· ÐºÐ°Ð¼ÐµÑ€Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾");

          // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ WebRTC
          peerConnection = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
          });
          stream
            .getTracks()
            .forEach((track) => peerConnection.addTrack(track, stream));
          console.log("ðŸŽ¥ Ð¢Ñ€ÐµÐºÐ¸ Ð´Ð¾Ð´Ð°Ð½Ñ– Ð´Ð¾ PeerConnection");

          // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ WebSocket
          socket = new WebSocket("wss://192.168.0.103:8080");

          socket.onopen = async () => {
            console.log("âœ… WebSocket Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾");
            // ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÑÑ”Ð¼Ð¾ ÑÐµÑ€Ð²ÐµÑ€, Ñ‰Ð¾ Ð¼Ð¸ broadcaster
            socket.send(JSON.stringify({ role: "broadcaster" }));

            // Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ñ– Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ”Ð¼Ð¾ offer
            try {
              const offer = await peerConnection.createOffer();
              await peerConnection.setLocalDescription(offer);
              if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ offer }));
                console.log("ðŸŽ¥ ÐÐ°Ð´Ñ–ÑÐ»Ð°Ð½Ð¾ offer:", offer);
              } else {
                console.warn("âš ï¸ WebSocket Ð½Ðµ Ð²Ñ–Ð´ÐºÑ€Ð¸Ñ‚Ð¸Ð¹ Ð´Ð»Ñ Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ð½Ð½Ñ offer");
              }
            } catch (error) {
              console.error("âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ– offer:", error);
            }
          };

          socket.onmessage = async (event) => {
            try {
              const message = JSON.parse(event.data);
              console.log("ðŸ“© ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ:", message);

              if (message.answer) {
                await peerConnection.setRemoteDescription(
                  new RTCSessionDescription(message.answer)
                );
                console.log("âœ… ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾ Ñ– Ð²ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ answer");
              } else if (message.iceCandidate) {
                await peerConnection.addIceCandidate(
                  new RTCIceCandidate(message.iceCandidate)
                );
                console.log("ðŸ§Š Ð”Ð¾Ð´Ð°Ð½Ð¾ ICE candidate:", message.iceCandidate);
              }
            } catch (error) {
              console.error("âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð¾Ð±Ñ†Ñ– Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ:", error);
            }
          };

          socket.onerror = (error) => {
            console.error("âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° WebSocket:", error);
          };

          socket.onclose = () => {
            console.log("âš ï¸ WebSocket Ð·Ð°ÐºÑ€Ð¸Ñ‚Ð¾");
          };

          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ iceCandidate: event.candidate }));
                console.log("ðŸ§Š ÐÐ°Ð´Ñ–ÑÐ»Ð°Ð½Ð¾ ICE candidate:", event.candidate);
              } else {
                console.warn(
                  "âš ï¸ WebSocket Ð½Ðµ Ð²Ñ–Ð´ÐºÑ€Ð¸Ñ‚Ð¸Ð¹ Ð´Ð»Ñ Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ð½Ð½Ñ ICE candidate"
                );
              }
            }
          };

          peerConnection.oniceconnectionstatechange = () => {
            console.log(
              "ðŸ§Š ICE Connection State:",
              peerConnection.iceConnectionState
            );
          };
        } catch (error) {
          console.error("âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ñƒ Ð´Ð¾ ÐºÐ°Ð¼ÐµÑ€Ð¸ Ð°Ð±Ð¾ WebRTC:", error);
        }

        // ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ€Ð¸Ñ‚Ñ‚Ñ– ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÐ¸
        window.onunload = () => {
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
            console.log("ðŸ›‘ WebSocket Ð·Ð°ÐºÑ€Ð¸Ñ‚Ð¾ Ð¿Ñ€Ð¸ Ð²Ð¸Ñ…Ð¾Ð´Ñ–");
          }
          if (peerConnection) {
            peerConnection.close();
            console.log("ðŸ›‘ PeerConnection Ð·Ð°ÐºÑ€Ð¸Ñ‚Ð¾ Ð¿Ñ€Ð¸ Ð²Ð¸Ñ…Ð¾Ð´Ñ–");
          }
          if (stream) {
            stream.getTracks().forEach((track) => track.stop());
            console.log("ðŸ›‘ ÐœÐµÐ´Ñ–Ð°Ð¿Ð¾Ñ‚Ñ–Ðº Ð·ÑƒÐ¿Ð¸Ð½ÐµÐ½Ð¾");
          }
        };
      };

      startStream();
    </script>
  </body>
</html>
